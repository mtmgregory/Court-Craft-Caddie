rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the resource
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    // Rounds collection - users can only access their own rounds
    match /rounds/{roundId} {
      allow read: if isOwner(resource.data.userId);
      allow create: if isSignedIn() 
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.keys().hasAll(['id', 'name', 'date', 'userId'])
                    && request.resource.data.name is string
                    && request.resource.data.name.size() > 0
                    && request.resource.data.name.size() <= 100;
      allow update: if isOwner(resource.data.userId)
                    && request.resource.data.userId == resource.data.userId
                    && request.resource.data.id == resource.data.id;
      allow delete: if isOwner(resource.data.userId);
    }
    
    // Shots collection - users can only access their own shots
    match /shots/{shotId} {
      allow read: if isSignedIn() 
                  && exists(/databases/$(database)/documents/rounds/$(resource.data.roundId))
                  && get(/databases/$(database)/documents/rounds/$(resource.data.roundId)).data.userId == request.auth.uid;
      
      allow create: if isSignedIn()
                    && exists(/databases/$(database)/documents/rounds/$(request.resource.data.roundId))
                    && get(/databases/$(database)/documents/rounds/$(request.resource.data.roundId)).data.userId == request.auth.uid
                    && request.resource.data.keys().hasAll(['id', 'roundId', 'hole', 'club', 'distance', 'result', 'lie', 'timestamp'])
                    && request.resource.data.hole >= 1 
                    && request.resource.data.hole <= 18
                    && request.resource.data.distance >= 0 
                    && request.resource.data.distance <= 600
                    && request.resource.data.club is string
                    && request.resource.data.club.size() > 0;
      
      allow update: if isSignedIn()
                    && exists(/databases/$(database)/documents/rounds/$(resource.data.roundId))
                    && get(/databases/$(database)/documents/rounds/$(resource.data.roundId)).data.userId == request.auth.uid
                    && request.resource.data.roundId == resource.data.roundId
                    && request.resource.data.id == resource.data.id;
      
      allow delete: if isSignedIn()
                    && exists(/databases/$(database)/documents/rounds/$(resource.data.roundId))
                    && get(/databases/$(database)/documents/rounds/$(resource.data.roundId)).data.userId == request.auth.uid;
    }
    
    // User preferences (optional - for storing user settings)
    match /users/{userId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
    }
  }
}